<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Timesheet demo</title>

  <!-- All widgets require jquery AND jquery UI -->
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

  <script src="../formula.js"></script>
  <script src="../library/referencetypes/Element.js"></script>

  <script src="../library/datatypes/SimpleTime.js"></script>
  <script src="../library/datatypes/boolean.js"></script>
  <script src="../library/datatypes/number.js"></script>

  <script src="../library/widgets/calculatedfield.js"></script>
  <script src="../library/widgets/formattedfield.js"></script>

  <script>

  function timeOrEmptyFormatter(obj) {
    if ((obj == null) || ((typeof obj == 'string') && (obj == ''))){
      return '';
    }
    return obj.format();
  }

  function timeOrEmptyDeformatter(text) {
    if ((text == null) || (text == '')){
      return '';
    }
    return SimpleTime.parse(text);
  }

  function twoDigitsFormatterZeroAsEmpty(num) {
    if (typeof num == 'string') {
      // assume it is already formatted
      return num;
    }
    if (typeof num == 'number') {
      var text = num.toFixed(2);
//      text = text.replace('.', ',');
      return text;
    }
  }
  function factoryHoursFormatter(num) {
    var text = twoDigitsFormatterZeroAsEmpty(num);
    if (text.length > 0) {
      text += 'h';
    }
    return text;
  }

  function fieldValue($elm) {
    if ($elm.hasClass('formatted-field')) {
      return $elm.formattedfield('getValue');
    }
    return $elm.val();
  }

  Formula.addFunctions(
    ['$SUM', function($jq) {
      var result=0;
      $jq.each(function() {
//        result += parseFloat($(this).val());
        result += numVal(fieldValue($(this)));
      });
      return result;
    }],
    ['USEDTIME', function(startTime, endTime) {
      //IF(AND(SIMPLETIME_IS_VALID(SIMPLETIME_PARSE(row:endtime)),SIMPLETIME_IS_VALID(SIMPLETIME_PARSE(row:starttime))),SIMPLETIME_SUBTRACT(SIMPLETIME_PARSE(row:endtime),SIMPLETIME_PARSE(row:starttime)), "")
//      if ((startTime == null) || (endTime == null)) {
      if ((!SimpleTime.isValidSimpleTime(startTime)) || (!SimpleTime.isValidSimpleTime(endTime))) {
//        console.log(startTime);
        return '';
      }
      return SimpleTime.subtract(endTime, startTime).toFactoryTime();
    }]
  );

  // Add "row:" reference-parser, which can reference a cell value in current row (tr)
  Formula.addParser(function(text, formulaObj) {
    if (text.substr(0,4) != 'row:') return
    var columnClass = text.substr(4);

    var $calculatedField = formulaObj.backReference;
    var $elm = $calculatedField.closest('tr').find('.' + columnClass);

    if ($elm.length == 0) {
      return '#REF error';
    }
    return {
      getValue: function () {
        return fieldValue($elm);
      },
      setChangeCallback: function(changeCallback) {
        $elm.on("change", changeCallback);
      },
      removeChangeCallback: function(changeCallback) {
        $elm.off("change", changeCallback);
      }
    }
  });

  // Add "." reference-parser, which can reference SEVERAL cells
  // It returns an array with the cell values
  Formula.addParser(function(text, formulaObj) {
    if (text[0] != '.') return
    var className = text.substr(1);

    var $elements = $(text);

    return {
      getValue: function () {
        return $elements;
      },
      setChangeCallback: function(changeCallback) {
        $elements.on("change", changeCallback);
      },
      removeChangeCallback: function(changeCallback) {
        $elements.off("change", changeCallback);
      }
    }
  });

  function addRow() {
    $row = $('#template_row').clone();
    $row.removeAttr('id');

    $row.find( ".starttime" ).add($row.find( ".endtime" )).formattedfield( {
      formatter: timeOrEmptyFormatter,
      deformatter: timeOrEmptyDeformatter,
//      value: new SimpleTime(10,10)
    });

    $row.appendTo('#sheet');

    $row.find( ".usedtime" ).calculatedfield( {
      formula: 'USEDTIME(row:starttime,row:endtime)',
//      formula: 'SUM(1,2)',
      formatter: factoryHoursFormatter,
    }).attr('disabled', 'disabled');

    return $row;
  }

  function setSheet(data) {
    // TODO: remove all rows first

/*    $( "#total" ).calculatedfield( "option", {
      formula: '""'
    });*/

    // Passivate the field, so it doesn't need to recalculate
    // each time a dependent field is added
    $( "#total" ).calculatedfield('unbindReferences');

    for (var row=0; row<data.length; row++) {
      var rowData = data[row];

      $row = addRow(rowData);

      $row.find('input').each(function() {
        var colname = $(this).attr('data-colname');
        if (rowData[colname]) {
          if ($(this).hasClass('formatted-field')) {
            $(this).formattedfield('setValueFromFormattedValue', rowData[colname]);
          }
          else {
            $(this).val(rowData[colname]);
          }
        }
      });
    }

    $('#sheet').find('input').trigger('change');

    // Now, activate it again, and recalculate
    $( "#total" ).calculatedfield('bindReferences');
    $( "#total" ).calculatedfield('calc');

/*
    $( "#total" ).calculatedfield( "option", {
      formula: '$SUM(.usedtime)'
    });      */

  }

  $(function() { 



    $( "#total" ).calculatedfield( {
//      formula: 'SUM(#ex1,FIELD_VALUE(#ex2.element))',
      formula: '$SUM(.usedtime)',
      formatter: factoryHoursFormatter
    });

    $(document).on('change', function(e) {
      if ($(e.target).closest('tr').is(':last-child')) {
        addRow();
        $( "#total" ).calculatedfield( "option", {
          formula: '$SUM(.usedtime)'
        });      

      }
    })

//    addRow(); 

    setSheet([
      {starttime:'10:10', endtime:'12:12'},
      {starttime:'14:10', endtime:'15:12'},
    ])
  });


  </script>
<style>
  body {max-width: 1200px; padding:2% 5%}
  input {width: 100px; border: 0; padding:2px 5px; display: block;}
  input.starttime, input.endtime, input.usedtime, #total {text-align: right;}
  input.starttime, input.endtime {width: 70px;}
  input.usedtime {width: 80px;}
  input.category {width: 240px}
  pre {font-family:monospace; padding: 10px; border: 1px solid #666; background-color: #eee}
  input[readonly] {background-color: #eee}
  table {border-collapse: collapse;}
  td { border: 1px solid #ddd}
  th {text-align: left; font-weight: normal; font-style: italic; font-size: 0.9em}
  td {vertical-align: top; padding:0}
  td pre {margin-top: 0px}

  input {
    background-color: white;
    color: #666;
  }
  #template_row {
    display: none;
  }


</style>

</head>
<body>
<h3>Timesheet</h3>
<table id="sheet">
  <tr>
    <th>Date</th>
    <th>Start</th>
    <th>End</th>
    <th>Used time</th>
    <th>Category</th>
  </tr>
  <tr id="template_row">
    <td><input class="date" data-colname="date"></input></td>
    <td><input class="starttime" data-colname="starttime"></input></td>
    <td><input class="endtime" data-colname="endtime"></input></td>
    <td><input class="usedtime" data-colname="usedtime"></input></td>
    <td><input class="category" data-colname="category"></input></td>
  </tr>
</table>

<br>
Total time spent: <input id="total"></input>
</body>
</html>
